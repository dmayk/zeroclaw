# =============================================================================
# Zeroclaw — Docker Compose for Synology NAS + Portainer
# =============================================================================
#
# 100% konfigurierbar über Portainer Environment-Variablen.
# Keine config.toml, kein SSH, kein git clone nötig.
#
# Verzeichnisstruktur auf der NAS:
#
#   /volume1/docker/zeroclaw/
#   ├── data/                  ← persistente Daten (SQLite, Keys, Workspace)
#   └── (Dockerfile)           ← nur für lokalen Build nötig
#
# Deployment via Portainer:
#   Stacks → Add Stack → Web editor → diese Datei einfügen
#   Environment variables setzen (mindestens ZEROCLAW_API_KEY)
# =============================================================================

services:
  zeroclaw:
    image: zeroclaw:latest
    container_name: zeroclaw
    restart: unless-stopped

    environment:
      # =======================================================================
      # LLM Provider (Pflicht: mindestens ZEROCLAW_API_KEY setzen)
      # =======================================================================
      - ZEROCLAW_PROVIDER=${ZEROCLAW_PROVIDER:-anthropic}
      - ZEROCLAW_MODEL=${ZEROCLAW_MODEL:-claude-sonnet-4-5-20250929}
      - ZEROCLAW_API_KEY=${ZEROCLAW_API_KEY}

      # =======================================================================
      # Memory
      # =======================================================================
      - ZEROCLAW_MEMORY_BACKEND=${ZEROCLAW_MEMORY_BACKEND:-sqlite}
      - ZEROCLAW_EMBEDDING_PROVIDER=${ZEROCLAW_EMBEDDING_PROVIDER:-openai}
      - ZEROCLAW_EMBEDDING_MODEL=${ZEROCLAW_EMBEDDING_MODEL:-text-embedding-3-small}
      - ZEROCLAW_EMBEDDING_API_KEY=${ZEROCLAW_EMBEDDING_API_KEY:-}

      # =======================================================================
      # Gateway
      # =======================================================================
      - ZEROCLAW_GATEWAY_HOST=${ZEROCLAW_GATEWAY_HOST:-0.0.0.0}
      - ZEROCLAW_GATEWAY_PORT=${ZEROCLAW_GATEWAY_PORT:-3000}

      # =======================================================================
      # Security
      # =======================================================================
      - ZEROCLAW_AUTONOMY=${ZEROCLAW_AUTONOMY:-supervised}

      # =======================================================================
      # Identity
      # =======================================================================
      - ZEROCLAW_IDENTITY_NAME=${ZEROCLAW_IDENTITY_NAME:-Zeroclaw}

      # =======================================================================
      # Messaging-Kanäle (Tokens in Portainer setzen)
      # =======================================================================

      # --- Telegram ---
      - ZEROCLAW_TELEGRAM_TOKEN=${ZEROCLAW_TELEGRAM_TOKEN:-}

      # --- Discord ---
      - ZEROCLAW_DISCORD_TOKEN=${ZEROCLAW_DISCORD_TOKEN:-}

      # --- Slack ---
      - ZEROCLAW_SLACK_BOT_TOKEN=${ZEROCLAW_SLACK_BOT_TOKEN:-}
      - ZEROCLAW_SLACK_APP_TOKEN=${ZEROCLAW_SLACK_APP_TOKEN:-}
      - ZEROCLAW_SLACK_SIGNING_SECRET=${ZEROCLAW_SLACK_SIGNING_SECRET:-}

      # --- WhatsApp ---
      - ZEROCLAW_WHATSAPP_TOKEN=${ZEROCLAW_WHATSAPP_TOKEN:-}
      - ZEROCLAW_WHATSAPP_VERIFY_TOKEN=${ZEROCLAW_WHATSAPP_VERIFY_TOKEN:-}
      - ZEROCLAW_WHATSAPP_PHONE_NUMBER_ID=${ZEROCLAW_WHATSAPP_PHONE_NUMBER_ID:-}

      # --- Matrix ---
      - ZEROCLAW_MATRIX_ACCESS_TOKEN=${ZEROCLAW_MATRIX_ACCESS_TOKEN:-}
      - ZEROCLAW_MATRIX_USER_ID=${ZEROCLAW_MATRIX_USER_ID:-}

      # --- Email ---
      - ZEROCLAW_EMAIL_USER=${ZEROCLAW_EMAIL_USER:-}
      - ZEROCLAW_EMAIL_PASSWORD=${ZEROCLAW_EMAIL_PASSWORD:-}
      - ZEROCLAW_EMAIL_IMAP_HOST=${ZEROCLAW_EMAIL_IMAP_HOST:-}
      - ZEROCLAW_EMAIL_IMAP_PORT=${ZEROCLAW_EMAIL_IMAP_PORT:-993}
      - ZEROCLAW_EMAIL_SMTP_HOST=${ZEROCLAW_EMAIL_SMTP_HOST:-}
      - ZEROCLAW_EMAIL_SMTP_PORT=${ZEROCLAW_EMAIL_SMTP_PORT:-587}

      # =======================================================================
      # Tunnel (Remote-Zugriff für Webhooks)
      # =======================================================================
      - ZEROCLAW_TUNNEL_KIND=${ZEROCLAW_TUNNEL_KIND:-}
      - ZEROCLAW_TUNNEL_TOKEN=${ZEROCLAW_TUNNEL_TOKEN:-}

    volumes:
      # Persistente Daten auf dem NAS-Dateisystem
      # Sichtbar in File Station, sicherbar mit Hyper Backup
      - /volume1/docker/zeroclaw/data:/home/zeroclaw/.zeroclaw

    ports:
      - "${ZEROCLAW_PORT:-3000}:3000"

    # Ressourcen-Limits via Portainer: Container → Edit → Resource Limits
    mem_limit: 256m

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    read_only: true
    tmpfs:
      - /tmp:size=64M

    networks:
      - zeroclaw-net

  # =========================================================================
  # Optional: Ollama für lokale LLM-Inference (kein API-Key nötig)
  # Achtung: Braucht mind. 8 GB RAM für kleine Modelle.
  # =========================================================================
  # ollama:
  #   image: ollama/ollama:latest
  #   container_name: ollama
  #   restart: unless-stopped
  #   volumes:
  #     - /volume1/docker/zeroclaw/ollama:/root/.ollama
  #   ports:
  #     - "11434:11434"
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 8G
  #         cpus: "4.0"
  #   networks:
  #     - zeroclaw-net

networks:
  zeroclaw-net:
    driver: bridge
